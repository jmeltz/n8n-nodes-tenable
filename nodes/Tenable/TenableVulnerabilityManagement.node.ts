import type {
	IDataObject,
	IExecuteFunctions,
	ILoadOptionsFunctions,
	INodeExecutionData,
	INodePropertyOptions,
	INodeType,
	INodeTypeDescription,
} from 'n8n-workflow';
import { tenableApiRequest, validateJSON } from './GenericFunctions';

export class TenableVulnerabilityManagement implements INodeType {
	description: INodeTypeDescription = {
		displayName: 'Tenable Vulnerability Management',
		name: 'tenableVulnerabilityManagement',
		icon: 'file:tenable.png',
		group: ['transform'],
		version: 1,
		subtitle: '={{$parameter["operation"] + ": " + $parameter["resource"]}}',
		description: 'Interact with Tenable Vulnerability Management API',
		defaults: {
			name: 'Tenable Vulnerability Management',
		},
		inputs: ['main'],
		outputs: ['main'],
		credentials: [
			{
				name: 'tenableApi',
				required: true,
			},
		],
		properties: [
			{
				displayName: 'Resource',
				name: 'resource',
				type: 'options',
				noDataExpression: true,
				options: [
					{
						name: 'Asset',
						value: 'asset',
					},
					{
						name: 'Export',
						value: 'export',
					},
					{
						name: 'Folder',
						value: 'folder',
					},
					{
						name: 'Plugin',
						value: 'plugin',
					},
					{
						name: 'Policy',
						value: 'policy',
					},
					{
						name: 'Scan',
						value: 'scan',
					},
					{
						name: 'Vulnerability',
						value: 'vulnerability',
					},
					{
						name: 'Workbench',
						value: 'workbench',
					},
				],
				default: 'scan',
			},

			// ----------------------------------
			//         Scan
			// ----------------------------------
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				noDataExpression: true,
				displayOptions: {
					show: {
						resource: ['scan'],
					},
				},
				options: [
					{
						name: 'Create',
						value: 'create',
						description: 'Create a new scan',
						action: 'Create a scan',
					},
					{
						name: 'Delete',
						value: 'delete',
						description: 'Delete a scan',
						action: 'Delete a scan',
					},
					{
						name: 'Get',
						value: 'get',
						description: 'Get a scan',
						action: 'Get a scan',
					},
					{
						name: 'Get Many',
						value: 'getAll',
						description: 'Get many scans',
						action: 'Get many scans',
					},
					{
						name: 'Launch',
						value: 'launch',
						description: 'Launch a scan',
						action: 'Launch a scan',
					},
					{
						name: 'Pause',
						value: 'pause',
						description: 'Pause a running scan',
						action: 'Pause a scan',
					},
					{
						name: 'Resume',
						value: 'resume',
						description: 'Resume a paused scan',
						action: 'Resume a scan',
					},
					{
						name: 'Stop',
						value: 'stop',
						description: 'Stop a running scan',
						action: 'Stop a scan',
					},
				],
				default: 'getAll',
			},

			// ----------------------------------
			//         Asset
			// ----------------------------------
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				noDataExpression: true,
				displayOptions: {
					show: {
						resource: ['asset'],
					},
				},
				options: [
					{
						name: 'Export All',
						value: 'exportAll',
						description: 'Export all assets (recommended for large datasets)',
						action: 'Export all assets',
					},
					{
						name: 'Get',
						value: 'get',
						description: 'Get an asset',
						action: 'Get an asset',
					},
					{
						name: 'Get Many',
						value: 'getAll',
						description: 'Get many assets (limited to ~5000)',
						action: 'Get many assets',
					},
					{
						name: 'Import',
						value: 'import',
						description: 'Import assets',
						action: 'Import assets',
					},
				],
				default: 'exportAll',
			},

			// ----------------------------------
			//         Export
			// ----------------------------------
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				noDataExpression: true,
				displayOptions: {
					show: {
						resource: ['export'],
					},
				},
				options: [
					{
						name: 'Cancel',
						value: 'cancel',
						description: 'Cancel an export',
						action: 'Cancel an export',
					},
					{
						name: 'Download Chunk',
						value: 'downloadChunk',
						description: 'Download an export chunk',
						action: 'Download an export chunk',
					},
					{
						name: 'Get Status',
						value: 'getStatus',
						description: 'Get export status',
						action: 'Get export status',
					},
					{
						name: 'Start Assets Export',
						value: 'startAssets',
						description: 'Start an assets export',
						action: 'Start an assets export',
					},
					{
						name: 'Start Compliance Export',
						value: 'startCompliance',
						description: 'Start a compliance export',
						action: 'Start a compliance export',
					},
					{
						name: 'Start Vulnerabilities Export',
						value: 'startVulns',
						description: 'Start a vulnerabilities export',
						action: 'Start a vulnerabilities export',
					},
				],
				default: 'startAssets',
			},

			// ----------------------------------
			//         Folder
			// ----------------------------------
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				noDataExpression: true,
				displayOptions: {
					show: {
						resource: ['folder'],
					},
				},
				options: [
					{
						name: 'Create',
						value: 'create',
						description: 'Create a folder',
						action: 'Create a folder',
					},
					{
						name: 'Delete',
						value: 'delete',
						description: 'Delete a folder',
						action: 'Delete a folder',
					},
					{
						name: 'Get Many',
						value: 'getAll',
						description: 'Get many folders',
						action: 'Get many folders',
					},
					{
						name: 'Update',
						value: 'update',
						description: 'Rename a folder',
						action: 'Update a folder',
					},
				],
				default: 'getAll',
			},

			// ----------------------------------
			//         Plugin
			// ----------------------------------
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				noDataExpression: true,
				displayOptions: {
					show: {
						resource: ['plugin'],
					},
				},
				options: [
					{
						name: 'Get',
						value: 'get',
						description: 'Get a plugin',
						action: 'Get a plugin',
					},
					{
						name: 'Get Families',
						value: 'getFamilies',
						description: 'Get all plugin families',
						action: 'Get plugin families',
					},
					{
						name: 'Get Family Plugins',
						value: 'getFamilyPlugins',
						description: 'Get plugins in a family',
						action: 'Get family plugins',
					},
				],
				default: 'getFamilies',
			},

			// ----------------------------------
			//         Policy
			// ----------------------------------
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				noDataExpression: true,
				displayOptions: {
					show: {
						resource: ['policy'],
					},
				},
				options: [
					{
						name: 'Copy',
						value: 'copy',
						description: 'Copy a policy',
						action: 'Copy a policy',
					},
					{
						name: 'Create',
						value: 'create',
						description: 'Create a policy',
						action: 'Create a policy',
					},
					{
						name: 'Delete',
						value: 'delete',
						description: 'Delete a policy',
						action: 'Delete a policy',
					},
					{
						name: 'Get',
						value: 'get',
						description: 'Get a policy',
						action: 'Get a policy',
					},
					{
						name: 'Get Many',
						value: 'getAll',
						description: 'Get many policies',
						action: 'Get many policies',
					},
				],
				default: 'getAll',
			},

			// ----------------------------------
			//         Vulnerability
			// ----------------------------------
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				noDataExpression: true,
				displayOptions: {
					show: {
						resource: ['vulnerability'],
					},
				},
				options: [
					{
						name: 'Get Many',
						value: 'getAll',
						description: 'Get many vulnerabilities',
						action: 'Get many vulnerabilities',
					},
				],
				default: 'getAll',
			},

			// ----------------------------------
			//         Workbench
			// ----------------------------------
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				noDataExpression: true,
				displayOptions: {
					show: {
						resource: ['workbench'],
					},
				},
				options: [
					{
						name: 'Get Asset Info',
						value: 'getAssetInfo',
						description: 'Get detailed asset information',
						action: 'Get asset info',
					},
					{
						name: 'Get Asset Vulnerabilities',
						value: 'getAssetVulns',
						description: 'Get vulnerabilities for an asset',
						action: 'Get asset vulnerabilities',
					},
					{
						name: 'Get Assets',
						value: 'getAssets',
						description: 'Get assets from workbench',
						action: 'Get workbench assets',
					},
					{
						name: 'Get Vulnerabilities',
						value: 'getVulns',
						description: 'Get vulnerabilities from workbench',
						action: 'Get workbench vulnerabilities',
					},
				],
				default: 'getAssets',
			},

			// ----------------------------------
			//         Fields
			// ----------------------------------

			// Scan ID field (used by multiple operations)
			{
				displayName: 'Scan Name or ID',
				name: 'scanId',
				type: 'options',
				typeOptions: {
					loadOptionsMethod: 'getScans',
				},
				required: true,
				displayOptions: {
					show: {
						resource: ['scan'],
						operation: ['get', 'delete', 'launch', 'pause', 'resume', 'stop'],
					},
				},
				default: '',
				description: 'The ID of the scan. Choose from the list, or specify an ID using an <a href="https://docs.n8n.io/code/expressions/">expression</a>.',
			},

			// Scan Create fields
			{
				displayName: 'Template Name or ID',
				name: 'templateUuid',
				type: 'options',
				typeOptions: {
					loadOptionsMethod: 'getScanTemplates',
				},
				required: true,
				displayOptions: {
					show: {
						resource: ['scan'],
						operation: ['create'],
					},
				},
				default: '',
				description: 'The UUID of the scan template to use. Choose from the list, or specify an ID using an <a href="https://docs.n8n.io/code/expressions/">expression</a>.',
			},
			{
				displayName: 'Scan Name',
				name: 'name',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['scan'],
						operation: ['create'],
					},
				},
				default: '',
				description: 'The name of the scan',
			},
			{
				displayName: 'Targets',
				name: 'textTargets',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['scan'],
						operation: ['create'],
					},
				},
				default: '',
				description: 'Comma-separated list of targets to scan (hostnames, IPs, IP ranges, CIDRs)',
			},
			{
				displayName: 'Additional Fields',
				name: 'additionalFields',
				type: 'collection',
				placeholder: 'Add Field',
				default: {},
				displayOptions: {
					show: {
						resource: ['scan'],
						operation: ['create'],
					},
				},
				options: [
					{
						displayName: 'Description',
						name: 'description',
						type: 'string',
						default: '',
						description: 'Description of the scan',
					},
					{
						displayName: 'Enabled',
						name: 'enabled',
						type: 'boolean',
						default: false,
						description: 'Whether the scan schedule is enabled',
					},
					{
						displayName: 'Folder Name or ID',
						name: 'folderId',
						type: 'options',
						typeOptions: {
							loadOptionsMethod: 'getFolders',
						},
						default: '',
						description: 'The folder to store the scan in. Choose from the list, or specify an ID using an <a href="https://docs.n8n.io/code/expressions/">expression</a>.',
					},
					{
						displayName: 'Launch',
						name: 'launch',
						type: 'options',
						options: [
							{ name: 'On Demand', value: 'ON_DEMAND' },
							{ name: 'Daily', value: 'DAILY' },
							{ name: 'Weekly', value: 'WEEKLY' },
							{ name: 'Monthly', value: 'MONTHLY' },
							{ name: 'Yearly', value: 'YEARLY' },
						],
						default: 'ON_DEMAND',
						description: 'When to launch the scan',
					},
					{
						displayName: 'Policy ID',
						name: 'policyId',
						type: 'number',
						default: 0,
						description: 'The ID of the policy to use',
					},
					{
						displayName: 'Scanner Name or ID',
						name: 'scannerId',
						type: 'options',
						typeOptions: {
							loadOptionsMethod: 'getScanners',
						},
						default: '',
						description: 'The scanner to use for the scan. Choose from the list, or specify an ID using an <a href="https://docs.n8n.io/code/expressions/">expression</a>.',
					},
				],
			},

			// Launch options
			{
				displayName: 'Launch Options',
				name: 'launchOptions',
				type: 'collection',
				placeholder: 'Add Option',
				default: {},
				displayOptions: {
					show: {
						resource: ['scan'],
						operation: ['launch'],
					},
				},
				options: [
					{
						displayName: 'Alt Targets',
						name: 'alt_targets',
						type: 'string',
						default: '',
						description: 'Comma-separated list of alternate targets to scan',
					},
				],
			},

			// Asset fields
			{
				displayName: 'Asset ID',
				name: 'assetId',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['asset'],
						operation: ['get'],
					},
				},
				default: '',
				description: 'The UUID of the asset',
			},
			{
				displayName: 'Assets (JSON)',
				name: 'assetsJson',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['asset'],
						operation: ['import'],
					},
				},
				default: '',
				description: 'JSON array of assets to import',
			},
			{
				displayName: 'Source',
				name: 'importSource',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['asset'],
						operation: ['import'],
					},
				},
				default: '',
				description: 'The source of the import (e.g., company name)',
			},

			// Asset Export All options
			{
				displayName: 'Export Options',
				name: 'assetExportOptions',
				type: 'collection',
				placeholder: 'Add Option',
				default: {},
				displayOptions: {
					show: {
						resource: ['asset'],
						operation: ['exportAll'],
					},
				},
				options: [
					{
						displayName: 'Chunk Size',
						name: 'chunk_size',
						type: 'number',
						typeOptions: {
							minValue: 100,
							maxValue: 10000,
						},
						default: 5000,
						description: 'Number of assets per chunk from Tenable API (max 10000)',
					},
					{
						displayName: 'Created After (Days)',
						name: 'created_at_days',
						type: 'number',
						default: 0,
						description: 'Only include assets created within the last N days (0 for all)',
					},
					{
						displayName: 'Include Unlicensed',
						name: 'include_unlicensed',
						type: 'boolean',
						default: false,
						description: 'Whether to include unlicensed assets',
					},
					{
						displayName: 'Poll Interval (Seconds)',
						name: 'poll_interval',
						type: 'number',
						typeOptions: {
							minValue: 5,
							maxValue: 300,
						},
						default: 10,
						description: 'How often to check export status',
					},
					{
						displayName: 'Timeout (Minutes)',
						name: 'timeout_minutes',
						type: 'number',
						typeOptions: {
							minValue: 1,
							maxValue: 60,
						},
						default: 30,
						description: 'Maximum time to wait for export to complete',
					},
					{
						displayName: 'Updated After (Days)',
						name: 'updated_at_days',
						type: 'number',
						default: 0,
						description: 'Only include assets updated within the last N days (0 for all)',
					},
				],
			},

			// Export fields
			{
				displayName: 'Export Type',
				name: 'exportType',
				type: 'options',
				options: [
					{ name: 'Assets', value: 'assets' },
					{ name: 'Compliance', value: 'compliance' },
					{ name: 'Vulnerabilities', value: 'vulns' },
				],
				required: true,
				displayOptions: {
					show: {
						resource: ['export'],
						operation: ['getStatus', 'cancel', 'downloadChunk'],
					},
				},
				default: 'assets',
			},
			{
				displayName: 'Export UUID',
				name: 'exportUuid',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['export'],
						operation: ['getStatus', 'cancel', 'downloadChunk'],
					},
				},
				default: '',
				description: 'The UUID of the export job',
			},
			{
				displayName: 'Chunk ID',
				name: 'chunkId',
				type: 'number',
				required: true,
				displayOptions: {
					show: {
						resource: ['export'],
						operation: ['downloadChunk'],
					},
				},
				default: 1,
				description: 'The chunk ID to download',
			},
			{
				displayName: 'Export Options',
				name: 'exportOptions',
				type: 'collection',
				placeholder: 'Add Option',
				default: {},
				displayOptions: {
					show: {
						resource: ['export'],
						operation: ['startAssets', 'startVulns', 'startCompliance'],
					},
				},
				options: [
					{
						displayName: 'Chunk Size',
						name: 'chunk_size',
						type: 'number',
						default: 1000,
						description: 'Number of records per chunk (max 10000)',
					},
					{
						displayName: 'Filters (JSON)',
						name: 'filters',
						type: 'string',
						default: '',
						description: 'JSON object of filters to apply',
					},
					{
						displayName: 'Include Unlicensed',
						name: 'include_unlicensed',
						type: 'boolean',
						default: false,
						description: 'Whether to include unlicensed assets',
					},
				],
			},

			// Folder fields
			{
				displayName: 'Folder Name',
				name: 'folderName',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['folder'],
						operation: ['create', 'update'],
					},
				},
				default: '',
				description: 'The name of the folder',
			},
			{
				displayName: 'Folder ID',
				name: 'folderId',
				type: 'number',
				required: true,
				displayOptions: {
					show: {
						resource: ['folder'],
						operation: ['delete', 'update'],
					},
				},
				default: 0,
				description: 'The ID of the folder',
			},

			// Plugin fields
			{
				displayName: 'Plugin ID',
				name: 'pluginId',
				type: 'number',
				required: true,
				displayOptions: {
					show: {
						resource: ['plugin'],
						operation: ['get'],
					},
				},
				default: 0,
				description: 'The ID of the plugin',
			},
			{
				displayName: 'Family ID',
				name: 'familyId',
				type: 'number',
				required: true,
				displayOptions: {
					show: {
						resource: ['plugin'],
						operation: ['getFamilyPlugins'],
					},
				},
				default: 0,
				description: 'The ID of the plugin family',
			},

			// Policy fields
			{
				displayName: 'Policy ID',
				name: 'policyId',
				type: 'number',
				required: true,
				displayOptions: {
					show: {
						resource: ['policy'],
						operation: ['get', 'delete', 'copy'],
					},
				},
				default: 0,
				description: 'The ID of the policy',
			},
			{
				displayName: 'Template Name or ID',
				name: 'policyTemplateUuid',
				type: 'options',
				typeOptions: {
					loadOptionsMethod: 'getPolicyTemplates',
				},
				required: true,
				displayOptions: {
					show: {
						resource: ['policy'],
						operation: ['create'],
					},
				},
				default: '',
				description: 'The UUID of the policy template. Choose from the list, or specify an ID using an <a href="https://docs.n8n.io/code/expressions/">expression</a>.',
			},
			{
				displayName: 'Policy Name',
				name: 'policyName',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['policy'],
						operation: ['create'],
					},
				},
				default: '',
				description: 'The name of the policy',
			},
			{
				displayName: 'Policy Settings (JSON)',
				name: 'policySettings',
				type: 'string',
				displayOptions: {
					show: {
						resource: ['policy'],
						operation: ['create'],
					},
				},
				default: '{}',
				description: 'Additional policy settings as JSON',
			},

			// Workbench fields
			{
				displayName: 'Asset ID',
				name: 'workbenchAssetId',
				type: 'string',
				required: true,
				displayOptions: {
					show: {
						resource: ['workbench'],
						operation: ['getAssetInfo', 'getAssetVulns'],
					},
				},
				default: '',
				description: 'The UUID of the asset',
			},
			{
				displayName: 'Workbench Options',
				name: 'workbenchOptions',
				type: 'collection',
				placeholder: 'Add Option',
				default: {},
				displayOptions: {
					show: {
						resource: ['workbench'],
						operation: ['getAssets', 'getVulns'],
					},
				},
				options: [
					{
						displayName: 'Date Range (Days)',
						name: 'date_range',
						type: 'number',
						default: 30,
						description: 'Number of days to include in results',
					},
					{
						displayName: 'Filter Search Type',
						name: 'filter_search_type',
						type: 'options',
						options: [
							{ name: 'And', value: 'and' },
							{ name: 'Or', value: 'or' },
						],
						default: 'and',
					},
					{
						displayName: 'Filters (JSON)',
						name: 'filters',
						type: 'string',
						default: '',
						description: 'JSON array of filter objects',
					},
				],
			},

			// Return All option for list operations
			{
				displayName: 'Return All',
				name: 'returnAll',
				type: 'boolean',
				displayOptions: {
					show: {
						resource: ['scan', 'asset', 'vulnerability', 'policy'],
						operation: ['getAll'],
					},
				},
				default: false,
				description: 'Whether to return all results or only up to a given limit',
			},
			{
				displayName: 'Limit',
				name: 'limit',
				type: 'number',
				displayOptions: {
					show: {
						resource: ['scan', 'asset', 'vulnerability', 'policy'],
						operation: ['getAll'],
						returnAll: [false],
					},
				},
				typeOptions: {
					minValue: 1,
				},
				default: 50,
				description: 'Max number of results to return',
			},
		],
	};

	methods = {
		loadOptions: {
			async getScans(this: ILoadOptionsFunctions): Promise<INodePropertyOptions[]> {
				const response = (await tenableApiRequest.call(this, 'GET', '/scans')) as IDataObject;
				const scans = response.scans as IDataObject[];
				if (!scans) return [];
				return scans.map((scan) => ({
					name: scan.name as string,
					value: scan.id as number,
				}));
			},

			async getScanTemplates(this: ILoadOptionsFunctions): Promise<INodePropertyOptions[]> {
				const response = (await tenableApiRequest.call(
					this,
					'GET',
					'/editor/scan/templates',
				)) as IDataObject;
				const templates = response.templates as IDataObject[];
				if (!templates) return [];
				return templates.map((template) => ({
					name: template.title as string,
					value: template.uuid as string,
				}));
			},

			async getPolicyTemplates(this: ILoadOptionsFunctions): Promise<INodePropertyOptions[]> {
				const response = (await tenableApiRequest.call(
					this,
					'GET',
					'/editor/policy/templates',
				)) as IDataObject;
				const templates = response.templates as IDataObject[];
				if (!templates) return [];
				return templates.map((template) => ({
					name: template.title as string,
					value: template.uuid as string,
				}));
			},

			async getFolders(this: ILoadOptionsFunctions): Promise<INodePropertyOptions[]> {
				const response = (await tenableApiRequest.call(this, 'GET', '/folders')) as IDataObject;
				const folders = response.folders as IDataObject[];
				if (!folders) return [];
				return folders.map((folder) => ({
					name: folder.name as string,
					value: folder.id as number,
				}));
			},

			async getScanners(this: ILoadOptionsFunctions): Promise<INodePropertyOptions[]> {
				const response = (await tenableApiRequest.call(this, 'GET', '/scanners')) as IDataObject;
				const scanners = response.scanners as IDataObject[];
				if (!scanners) return [];
				return scanners.map((scanner) => ({
					name: scanner.name as string,
					value: scanner.uuid as string,
				}));
			},
		},
	};

	async execute(this: IExecuteFunctions): Promise<INodeExecutionData[][]> {
		const items = this.getInputData();
		const returnData: INodeExecutionData[] = [];
		const resource = this.getNodeParameter('resource', 0) as string;
		const operation = this.getNodeParameter('operation', 0) as string;

		for (let i = 0; i < items.length; i++) {
			try {
				let responseData: IDataObject | IDataObject[] = {};

				// ----------------------------------
				//         Scan Operations
				// ----------------------------------
				if (resource === 'scan') {
					if (operation === 'getAll') {
						const returnAll = this.getNodeParameter('returnAll', i) as boolean;
						const response = (await tenableApiRequest.call(this, 'GET', '/scans')) as IDataObject;
						responseData = response.scans as IDataObject[];
						if (!returnAll) {
							const limit = this.getNodeParameter('limit', i) as number;
							responseData = (responseData as IDataObject[]).slice(0, limit);
						}
					}

					if (operation === 'get') {
						const scanId = this.getNodeParameter('scanId', i) as number;
						responseData = (await tenableApiRequest.call(
							this,
							'GET',
							`/scans/${scanId}`,
						)) as IDataObject;
					}

					if (operation === 'create') {
						const templateUuid = this.getNodeParameter('templateUuid', i) as string;
						const name = this.getNodeParameter('name', i) as string;
						const textTargets = this.getNodeParameter('textTargets', i) as string;
						const additionalFields = this.getNodeParameter('additionalFields', i) as IDataObject;

						const settings: IDataObject = {
							name,
							text_targets: textTargets,
						};

						if (additionalFields.description) {
							settings.description = additionalFields.description;
						}
						if (additionalFields.enabled !== undefined) {
							settings.enabled = additionalFields.enabled;
						}
						if (additionalFields.folderId) {
							settings.folder_id = additionalFields.folderId;
						}
						if (additionalFields.launch) {
							settings.launch = additionalFields.launch;
						}
						if (additionalFields.policyId) {
							settings.policy_id = additionalFields.policyId;
						}
						if (additionalFields.scannerId) {
							settings.scanner_id = additionalFields.scannerId;
						}

						const body: IDataObject = {
							uuid: templateUuid,
							settings,
						};

						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							'/scans',
							body,
						)) as IDataObject;
					}

					if (operation === 'delete') {
						const scanId = this.getNodeParameter('scanId', i) as number;
						await tenableApiRequest.call(this, 'DELETE', `/scans/${scanId}`);
						responseData = { success: true };
					}

					if (operation === 'launch') {
						const scanId = this.getNodeParameter('scanId', i) as number;
						const launchOptions = this.getNodeParameter('launchOptions', i) as IDataObject;
						const body: IDataObject = {};

						if (launchOptions.alt_targets) {
							body.alt_targets = (launchOptions.alt_targets as string).split(',').map((t) => t.trim());
						}

						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							`/scans/${scanId}/launch`,
							body,
						)) as IDataObject;
					}

					if (operation === 'pause') {
						const scanId = this.getNodeParameter('scanId', i) as number;
						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							`/scans/${scanId}/pause`,
						)) as IDataObject;
					}

					if (operation === 'resume') {
						const scanId = this.getNodeParameter('scanId', i) as number;
						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							`/scans/${scanId}/resume`,
						)) as IDataObject;
					}

					if (operation === 'stop') {
						const scanId = this.getNodeParameter('scanId', i) as number;
						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							`/scans/${scanId}/stop`,
						)) as IDataObject;
					}
				}

				// ----------------------------------
				//         Asset Operations
				// ----------------------------------
				if (resource === 'asset') {
					if (operation === 'getAll') {
						const returnAll = this.getNodeParameter('returnAll', i) as boolean;

						if (returnAll) {
							// Fetch all assets using pagination (max 5000 per page)
							const allAssets: IDataObject[] = [];
							const pageSize = 5000;
							let page = 0;
							let hasMore = true;

							while (hasMore) {
								const qs: IDataObject = {
									size: pageSize,
									page: page,
								};
								const response = (await tenableApiRequest.call(
									this,
									'GET',
									'/assets',
									{},
									qs,
								)) as IDataObject;
								const assets = response.assets as IDataObject[];

								if (assets && assets.length > 0) {
									allAssets.push(...assets);
									// If we got less than pageSize, we've reached the end
									if (assets.length < pageSize) {
										hasMore = false;
									} else {
										page++;
									}
								} else {
									hasMore = false;
								}
							}
							responseData = allAssets;
						} else {
							const limit = this.getNodeParameter('limit', i) as number;
							const qs: IDataObject = {
								size: Math.min(limit, 5000),
							};
							const response = (await tenableApiRequest.call(
								this,
								'GET',
								'/assets',
								{},
								qs,
							)) as IDataObject;
							responseData = response.assets as IDataObject[];
							if (responseData && limit < (responseData as IDataObject[]).length) {
								responseData = (responseData as IDataObject[]).slice(0, limit);
							}
						}
					}

					if (operation === 'get') {
						const assetId = this.getNodeParameter('assetId', i) as string;
						responseData = (await tenableApiRequest.call(
							this,
							'GET',
							`/assets/${assetId}`,
						)) as IDataObject;
					}

					if (operation === 'import') {
						const assetsJson = this.getNodeParameter('assetsJson', i) as string;
						const source = this.getNodeParameter('importSource', i) as string;

						const assets = validateJSON(assetsJson);
						if (!assets) {
							throw new Error('Invalid JSON in Assets field');
						}

						const body: IDataObject = {
							assets,
							source,
						};

						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							'/import/assets',
							body,
						)) as IDataObject;
					}

					if (operation === 'exportAll') {
						const options = this.getNodeParameter('assetExportOptions', i) as IDataObject;

						// Build export request body
						const exportBody: IDataObject = {};

						if (options.chunk_size) {
							exportBody.chunk_size = options.chunk_size;
						}
						if (options.include_unlicensed !== undefined) {
							exportBody.include_unlicensed = options.include_unlicensed;
						}

						// Handle date filters
						if (options.created_at_days && (options.created_at_days as number) > 0) {
							const daysAgo = Math.floor(Date.now() / 1000) - ((options.created_at_days as number) * 24 * 60 * 60);
							exportBody.filters = exportBody.filters || {};
							(exportBody.filters as IDataObject).created_at = daysAgo;
						}
						if (options.updated_at_days && (options.updated_at_days as number) > 0) {
							const daysAgo = Math.floor(Date.now() / 1000) - ((options.updated_at_days as number) * 24 * 60 * 60);
							exportBody.filters = exportBody.filters || {};
							(exportBody.filters as IDataObject).updated_at = daysAgo;
						}

						const pollInterval = ((options.poll_interval as number) || 10) * 1000;
						const timeoutMs = ((options.timeout_minutes as number) || 30) * 60 * 1000;
						const startTime = Date.now();

						// Step 1: Start the export (or resume existing one)
						let exportUuid: string;

						try {
							const exportResponse = (await tenableApiRequest.call(
								this,
								'POST',
								'/assets/export',
								exportBody,
							)) as IDataObject;

							exportUuid = exportResponse.export_uuid as string;
							if (!exportUuid) {
								throw new Error('Failed to start asset export - no export UUID returned');
							}
						} catch (error) {
							// Check if there's an existing export we can resume
							const errorMessage = (error as Error).message || '';
							const existingUuidMatch = errorMessage.match(/job_uuid=([a-f0-9-]+)/i);

							if (existingUuidMatch && existingUuidMatch[1]) {
								// Resume monitoring the existing export
								exportUuid = existingUuidMatch[1];
							} else {
								throw error;
							}
						}

						// Step 2: Poll for completion
						let exportStatus = '';
						let chunksAvailable: number[] = [];

						while (exportStatus !== 'FINISHED' && exportStatus !== 'CANCELLED' && exportStatus !== 'ERROR') {
							// Check timeout
							if (Date.now() - startTime > timeoutMs) {
								throw new Error(`Asset export timed out after ${options.timeout_minutes || 30} minutes. Export UUID: ${exportUuid}`);
							}

							// Wait before polling
							await new Promise((resolve) => setTimeout(resolve, pollInterval));

							const statusResponse = (await tenableApiRequest.call(
								this,
								'GET',
								`/assets/export/${exportUuid}/status`,
							)) as IDataObject;

							exportStatus = statusResponse.status as string;
							chunksAvailable = (statusResponse.chunks_available as number[]) || [];
						}

						if (exportStatus === 'ERROR') {
							throw new Error(`Asset export failed with status ERROR. Export UUID: ${exportUuid}`);
						}

						if (exportStatus === 'CANCELLED') {
							throw new Error(`Asset export was cancelled. Export UUID: ${exportUuid}`);
						}

						// Step 3: Output chunk information for downstream processing
						// This allows n8n to manage memory by processing one chunk at a time
						const outputItems: INodeExecutionData[] = [];

						for (let i = 0; i < chunksAvailable.length; i++) {
							outputItems.push({
								json: {
									exportUuid,
									chunkId: chunksAvailable[i],
									chunkIndex: i,
									totalChunks: chunksAvailable.length,
									exportType: 'assets',
								},
							});
						}

						return [outputItems];
					}
				}

				// ----------------------------------
				//         Export Operations
				// ----------------------------------
				if (resource === 'export') {
					if (operation === 'startAssets') {
						const options = this.getNodeParameter('exportOptions', i) as IDataObject;
						const body: IDataObject = {};

						if (options.chunk_size) {
							body.chunk_size = options.chunk_size;
						}
						if (options.include_unlicensed !== undefined) {
							body.include_unlicensed = options.include_unlicensed;
						}
						if (options.filters) {
							const filters = validateJSON(options.filters as string);
							if (filters) {
								body.filters = filters;
							}
						}

						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							'/assets/export',
							body,
						)) as IDataObject;
					}

					if (operation === 'startVulns') {
						const options = this.getNodeParameter('exportOptions', i) as IDataObject;
						const body: IDataObject = {};

						if (options.chunk_size) {
							body.num_assets = options.chunk_size;
						}
						if (options.include_unlicensed !== undefined) {
							body.include_unlicensed = options.include_unlicensed;
						}
						if (options.filters) {
							const filters = validateJSON(options.filters as string);
							if (filters) {
								body.filters = filters;
							}
						}

						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							'/vulns/export',
							body,
						)) as IDataObject;
					}

					if (operation === 'startCompliance') {
						const options = this.getNodeParameter('exportOptions', i) as IDataObject;
						const body: IDataObject = {};

						if (options.chunk_size) {
							body.num_findings = options.chunk_size;
						}
						if (options.filters) {
							const filters = validateJSON(options.filters as string);
							if (filters) {
								body.filters = filters;
							}
						}

						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							'/compliance/export',
							body,
						)) as IDataObject;
					}

					if (operation === 'getStatus') {
						const exportType = this.getNodeParameter('exportType', i) as string;
						const exportUuid = this.getNodeParameter('exportUuid', i) as string;

						responseData = (await tenableApiRequest.call(
							this,
							'GET',
							`/${exportType}/export/${exportUuid}/status`,
						)) as IDataObject;
					}

					if (operation === 'cancel') {
						const exportType = this.getNodeParameter('exportType', i) as string;
						const exportUuid = this.getNodeParameter('exportUuid', i) as string;

						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							`/${exportType}/export/${exportUuid}/cancel`,
						)) as IDataObject;
					}

					if (operation === 'downloadChunk') {
						const exportType = this.getNodeParameter('exportType', i) as string;
						const exportUuid = this.getNodeParameter('exportUuid', i) as string;
						const chunkId = this.getNodeParameter('chunkId', i) as number;

						responseData = (await tenableApiRequest.call(
							this,
							'GET',
							`/${exportType}/export/${exportUuid}/chunks/${chunkId}`,
						)) as IDataObject;
					}
				}

				// ----------------------------------
				//         Folder Operations
				// ----------------------------------
				if (resource === 'folder') {
					if (operation === 'getAll') {
						const response = (await tenableApiRequest.call(this, 'GET', '/folders')) as IDataObject;
						responseData = response.folders as IDataObject[];
					}

					if (operation === 'create') {
						const name = this.getNodeParameter('folderName', i) as string;
						responseData = (await tenableApiRequest.call(this, 'POST', '/folders', {
							name,
						})) as IDataObject;
					}

					if (operation === 'delete') {
						const folderId = this.getNodeParameter('folderId', i) as number;
						await tenableApiRequest.call(this, 'DELETE', `/folders/${folderId}`);
						responseData = { success: true };
					}

					if (operation === 'update') {
						const folderId = this.getNodeParameter('folderId', i) as number;
						const name = this.getNodeParameter('folderName', i) as string;
						await tenableApiRequest.call(this, 'PUT', `/folders/${folderId}`, { name });
						responseData = { success: true };
					}
				}

				// ----------------------------------
				//         Plugin Operations
				// ----------------------------------
				if (resource === 'plugin') {
					if (operation === 'getFamilies') {
						const response = (await tenableApiRequest.call(
							this,
							'GET',
							'/plugins/families',
						)) as IDataObject;
						responseData = response.families as IDataObject[];
					}

					if (operation === 'getFamilyPlugins') {
						const familyId = this.getNodeParameter('familyId', i) as number;
						const response = (await tenableApiRequest.call(
							this,
							'GET',
							`/plugins/families/${familyId}`,
						)) as IDataObject;
						responseData = response.plugins as IDataObject[];
					}

					if (operation === 'get') {
						const pluginId = this.getNodeParameter('pluginId', i) as number;
						responseData = (await tenableApiRequest.call(
							this,
							'GET',
							`/plugins/plugin/${pluginId}`,
						)) as IDataObject;
					}
				}

				// ----------------------------------
				//         Policy Operations
				// ----------------------------------
				if (resource === 'policy') {
					if (operation === 'getAll') {
						const returnAll = this.getNodeParameter('returnAll', i) as boolean;
						const response = (await tenableApiRequest.call(
							this,
							'GET',
							'/policies',
						)) as IDataObject;
						responseData = response.policies as IDataObject[];
						if (!returnAll) {
							const limit = this.getNodeParameter('limit', i) as number;
							responseData = (responseData as IDataObject[]).slice(0, limit);
						}
					}

					if (operation === 'get') {
						const policyId = this.getNodeParameter('policyId', i) as number;
						responseData = (await tenableApiRequest.call(
							this,
							'GET',
							`/policies/${policyId}`,
						)) as IDataObject;
					}

					if (operation === 'create') {
						const templateUuid = this.getNodeParameter('policyTemplateUuid', i) as string;
						const name = this.getNodeParameter('policyName', i) as string;
						const settingsJson = this.getNodeParameter('policySettings', i) as string;

						const settings = validateJSON(settingsJson) || {};
						(settings as IDataObject).name = name;

						const body: IDataObject = {
							uuid: templateUuid,
							settings,
						};

						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							'/policies',
							body,
						)) as IDataObject;
					}

					if (operation === 'delete') {
						const policyId = this.getNodeParameter('policyId', i) as number;
						await tenableApiRequest.call(this, 'DELETE', `/policies/${policyId}`);
						responseData = { success: true };
					}

					if (operation === 'copy') {
						const policyId = this.getNodeParameter('policyId', i) as number;
						responseData = (await tenableApiRequest.call(
							this,
							'POST',
							`/policies/${policyId}/copy`,
						)) as IDataObject;
					}
				}

				// ----------------------------------
				//         Vulnerability Operations
				// ----------------------------------
				if (resource === 'vulnerability') {
					if (operation === 'getAll') {
						const returnAll = this.getNodeParameter('returnAll', i) as boolean;
						const response = (await tenableApiRequest.call(
							this,
							'GET',
							'/api/v2/vulnerabilities',
						)) as IDataObject;
						responseData = response.vulnerabilities as IDataObject[];
						if (!returnAll && responseData) {
							const limit = this.getNodeParameter('limit', i) as number;
							responseData = (responseData as IDataObject[]).slice(0, limit);
						}
					}
				}

				// ----------------------------------
				//         Workbench Operations
				// ----------------------------------
				if (resource === 'workbench') {
					if (operation === 'getAssets') {
						const options = this.getNodeParameter('workbenchOptions', i) as IDataObject;
						const qs: IDataObject = {};

						if (options.date_range) {
							qs.date_range = options.date_range;
						}
						if (options.filter_search_type) {
							qs.filter_search_type = options.filter_search_type;
						}

						const response = (await tenableApiRequest.call(
							this,
							'GET',
							'/workbenches/assets',
							{},
							qs,
						)) as IDataObject;
						responseData = response.assets as IDataObject[];
					}

					if (operation === 'getAssetInfo') {
						const assetId = this.getNodeParameter('workbenchAssetId', i) as string;
						const response = (await tenableApiRequest.call(
							this,
							'GET',
							`/workbenches/assets/${assetId}/info`,
						)) as IDataObject;
						responseData = response.info as IDataObject;
					}

					if (operation === 'getAssetVulns') {
						const assetId = this.getNodeParameter('workbenchAssetId', i) as string;
						const response = (await tenableApiRequest.call(
							this,
							'GET',
							`/workbenches/assets/${assetId}/vulnerabilities`,
						)) as IDataObject;
						responseData = response.vulnerabilities as IDataObject[];
					}

					if (operation === 'getVulns') {
						const options = this.getNodeParameter('workbenchOptions', i) as IDataObject;
						const qs: IDataObject = {};

						if (options.date_range) {
							qs.date_range = options.date_range;
						}
						if (options.filter_search_type) {
							qs.filter_search_type = options.filter_search_type;
						}

						const response = (await tenableApiRequest.call(
							this,
							'GET',
							'/workbenches/vulnerabilities',
							{},
							qs,
						)) as IDataObject;
						responseData = response.vulnerabilities as IDataObject[];
					}
				}

				const executionData = this.helpers.constructExecutionMetaData(
					this.helpers.returnJsonArray(responseData as IDataObject[]),
					{ itemData: { item: i } },
				);
				returnData.push(...executionData);
			} catch (error) {
				if (this.continueOnFail()) {
					returnData.push({ json: { error: (error as Error).message } });
					continue;
				}
				throw error;
			}
		}

		return [returnData];
	}
}
